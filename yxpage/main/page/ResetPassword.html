<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  >
  <link
    rel="stylesheet"
    href="../../main/layui/css/layui.css"
  >
  <script src="../../main/layui/layui.js"></script>
</head>

<style>
  * {
    margin: 0px;
    padding: 0px;
  }

  .resetpwd_box {
    position: relative;
  }

  .resetpwd_content {
    width: 80%;
    position: absolute;
    height: 80vh;
    margin: 5% 10%;
  }

  .resetpwd_contentTop {
    width: 100%;
    border-bottom: 1px solid #cccccc;
    height: 10%;
    font-size: 22px;
    color: #405869;
    position: relative;
  }

  .resetpwd_contentTop span {
    bottom: 4px;
    position: absolute;
  }

  .resetpwd_contentCent {
    width: 100%;
    height: 4%;
    margin-top: 1%;
    display: flex;
    justify-content: space-between;
  }

  .resetpwd_contentCentO {
    color: #ffffff;
    font-size: 14px;
    background-color: #2A94E6;
    width: 24%;
    height: 40px;
    cursor: pointer;
    text-align: center;
    display: block;
    line-height: 40px;
  }

  .resetpwd_contentCentT {
    color: #ffffff;
    font-size: 14px;
    background-color: #CACACA;
    width: 24%;
    height: 40px;
    cursor: pointer;
    text-align: center;
    line-height: 40px;
  }

  .resetpwd_contentCentF {
    color: #ffffff;
    font-size: 14px;
    background-color: #CACACA;
    width: 24%;
    height: 40px;
    cursor: pointer;
    text-align: center;
    line-height: 40px;
  }

  .resetpwd_contentCentS {
    color: #ffffff;
    font-size: 14px;
    background-color: #CACACA;
    width: 24%;
    height: 40px;
    cursor: pointer;
    text-align: center;
    line-height: 40px;
  }

  .resetpwd_contentBottom {
    width: 100%;
    height: 80%;
    margin-top: 2%;
    border: 1px solid #CCCCCC;
  }

  .resetpwd_contentBottomO {
    display: block;
  }

  .resetpwd_contentBottomT {
    display: none;
  }

  .resetpwd_contentBottomF {
    display: none;
  }

  .resetpwd_contentBottomS {
    display: none;
    height: 80%;
    margin: 5% auto;
  }

  .confirmAccount {
    width: 40%;
    height: 400px;
    margin: 5% auto;
  }

  .securityCheck {
    width: 40%;
    height: 400px;
    margin: 5% auto;
  }

  .setPassword {
    width: 40%;
    height: 400px;
    margin: 5% auto;
  }
</style>

<body>
  <div class="resetpwd_box">
    <div class="resetpwd_content">
      <div class="resetpwd_contentTop">
        <span>找回密码</span>
      </div>
      <div class="resetpwd_contentCent">
        <span class="resetpwd_contentCentO">1、确认账号</span>
        <span class="resetpwd_contentCentT">2、安全校验</span>
        <span class="resetpwd_contentCentF">3、设置密码</span>
        <span class="resetpwd_contentCentS">4、完成</span>
      </div>
      <div class="resetpwd_contentBottom">
        <div class="resetpwd_contentBottomO">
          <div class="confirmAccount">
            <span style="color:#101010;font-size:16px;">请输入你要找回密码的手机号码</span>
            <div style="display: flex;">
              <span
                style="width:10%;margin-top:6%;border:1px solid #eee;border-right:0;font-size: 16px;height:40px;line-height:40px;padding-left:4%;"
              >+86</span>
              <input
                style="width:100%;margin-top:6%; height:42px;"
                type="phone"
                name="phone"
                required
                lay-verify="required"
                placeholder="请输入手机号码"
                maxlength="11"
                autocomplete="off"
                class="layui-input"
                id="input-phone-num"
                value=""
              >
            </div>
            <div style="display: flex;">
              <button
                type="button"
                class="layui-btn layui-btn-normal"
                style="width:200px;margin: 6% auto;"
                id="confirmAccountNext"
              >下一步</button>
            </div>
            <div style="margin:2% 25%;text-align: center;">
              <span style="color:#666666;cursor: pointer;">记起密码？</span>
              <span><a
                  style="color:#2A94E6;cursor: pointer;"
                  href="../login.html"
                >立即登录</a></span>
            </div>
          </div>
        </div>
        <div class="resetpwd_contentBottomT">
          <div class="securityCheck">
            <span style="color:#101010;font-size:16px;">为了您的账户安全，请先验证手机</span>
            <div style="display: flex;">
              <span
                style="width:10%;margin-top:6%;border:1px solid #eee;border-right:0;font-size: 16px;height:40px;line-height:40px;padding-left:4%;"
              >+86</span>
              <input
                style="width:100%;margin-top:6%;height:42px;"
                disabled
                type="phone"
                name="phone"
                required
                lay-verify="required"
                placeholder="请输入手机号码"
                autocomplete="off"
                class="layui-input"
                id="input-phone-num2"
              >
            </div>
            <div style="display: flex;">
              <input
                style="width:100%;margin-top:6%;height:43px;"
                type="phone"
                name="phone"
                required
                lay-verify="required"
                placeholder="请输入验证码"
                autocomplete="off"
                class="layui-input"
                id="input-phone-code"
              >
              <button
                style="margin-top:6%;height:42px;"
                type="button"
                class="layui-btn layui-btn-normal"
                id="send-code"
              >发送验证码</button>
            </div>
            <div style="display: flex;">
              <button
                type="button"
                class="layui-btn layui-btn-normal"
                style="width:200px;margin: 6% auto;"
                id="securityCheckNext"
              >下一步</button>
            </div>
            <div style="margin:2% 0;text-align: center;">
              <span style="color:#666666;cursor: pointer;">记起密码？</span>
              <span><a
                  style="color:#2A94E6;cursor: pointer;"
                  href="../login.html"
                >立即登录</a></span>
              <span
                style="color:#e69c07;cursor: pointer;padding: auto 5px;"
                id="back-step-o"
              >[上一步]</span>
            </div>
          </div>
        </div>
        <div class="resetpwd_contentBottomF">
          <div class="setPassword">
            <span style="color:#101010;font-size:16px;">设置新密码</span>
            </br>
            <!-- <span style="color:#999999;font-size:14px;">商户账号密码一致，修改后会对该手机号对应的所有门店都生效</span> -->
            <input
              style="width:60%;margin-top:6%;height:43px;"
              type="password"
              name="password"
              required
              lay-verify="required"
              placeholder="请输入新密码"
              autocomplete="off"
              class="layui-input"
              id="pwd"
            >
            <input
              style="width:60%;margin-top:6%;height:43px;"
              type="password"
              name="password"
              required
              lay-verify="required"
              placeholder="请再次输入新密码"
              autocomplete="off"
              class="layui-input"
              id="affirm_pwd"
            >
            <div style="margin-top:2%;">
              <span style="color:#999999;font-size:14px;">密码必须包含大小写字母+数字+特殊字符至少8位</span>
            </div>
            <button
              type="button"
              class="layui-btn layui-btn-normal"
              style="margin-top:6%;width:200px;"
              id="setPasswordNext"
            >保存新密码</button>
            <div style="margin:2% auto;">
              <span style="color:#666666;cursor: pointer;">记起密码？</span>
              <span><a
                  style="color:#2A94E6;cursor: pointer;"
                  href="../login.html"
                >立即登录</a></span>
              <span
                style="color:#e69c07;cursor: pointer;padding: auto 5px;"
                id="back-step-t"
              >[上一步]</span>
            </div>
          </div>
        </div>
        <div class="resetpwd_contentBottomS">
          <div
            style="display: flex; align-items: center;flex-direction: column; justify-content: center; height: 100%;">
            <i
              class="layui-icon layui-icon-ok-circle"
              style="color: #00cf98;font-size: 80px;"
            ></i>
            <h1 style="padding:5px">您已成功重置密码</h1>
            <p style="padding:5px">您的登录密码已重新设置，请妥善保管。</p>


            <span>
              <a
                style="font-size: 22px; color:#2A94E6;"
                href="../login.html"
              >
                跳转到登录
              </a>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/jquery-3.7.1.min.js"></script>
  <script src="/js/jquery-migrate-3.4.1.min.js"></script>
  <script src="../../js/crypto-js.min.js"></script>
  <script src="../../js/jquery.cookie.js"></script>
  <script
    type="text/javascript"
    src="../../js/server.js"
  ></script>
  <script
    type="text/javascript"
    src="../../js/server_common.js"
  ></script>
  <script type="text/javascript">
    $(function () {
      //确认账号
      var stepActiveBgColor = '#2A94E6'
      var stepOkBgColor = '#72c1eb'
      var stepNoneBgColor = '#CACACA'
      var confirmAccountNextState = false
      var securityCheckState = false
      var setPasswordNextState = false
      var onCheckOkStep = []
      var allStep = ['resetpwd_contentBottomO', 'resetpwd_contentBottomT', 'resetpwd_contentBottomF', 'resetpwd_contentBottomS']
      var allStepTitle = ['resetpwd_contentCentO', 'resetpwd_contentCentT', 'resetpwd_contentCentF', 'resetpwd_contentCentS']
      var active = 0
      function setStyle() {
        onCheckOkStep = []
        for (let i = 0; i < allStep.length; i++) {
          if (active == i) {
            $('.' + allStep[i]).show()
            $('.' + allStepTitle[i]).css('background-color', stepActiveBgColor)
          } else {
            $('.' + allStep[i]).hide()
            if (i < active) {
              onCheckOkStep.push(allStepTitle[i])
              $('.' + allStepTitle[i]).css('background-color', stepOkBgColor)
            } else {
              $('.' + allStepTitle[i]).css('background-color', stepNoneBgColor)
            }
          }
        }
      }
      setStyle()
      //回到第一步
      $('#back-step-o').click(() => {
        active = 0

        setStyle()
      })
      //回到第一步
      $('#back-step-t').click(() => {
        active = 1

        setStyle()
      })
      //回到第一步
      // $('#back-step-o','#back-step-t','#back-step-f').click(()=>{
      // 	active = 0

      // 	setStyle()
      // })
      //安全校验 第一步
      $('#confirmAccountNext').click(() => {
        var phoneNum = $('#input-phone-num').val();

        var regex = new RegExp("^1[0-9]\\d{9}");

        if (!regex.test(phoneNum)) {
          confirmAccountNextState = false
          alert("请输入正确的手机号！")
          return
        }

        $('#input-phone-num2').val(phoneNum);
        checkPhoneNum(phoneNum)

      })
      // 校验验证码 第二步
      $('#securityCheckNext').click(() => {
        var phoneNum = $('#input-phone-num2').val();
        var phoneCode = $('#input-phone-code').val();
        var regex = new RegExp("^1[0-9]\\d{9}");
        var regecode = new RegExp("^[0-9]\{6,6}$");

        if (!regex.test(phoneNum)) {
          // confirmAccountNextState = false
          alert("请输入正确的手机号！")
          return
        }
        if (!regecode.test(phoneCode)) {
          document.getElementById('input-phone-code').value
          // confirmAccountNextState = false
          alert("验证码格式不正确！")
          return
        }
        checkPhoneCode(phoneCode)
      })

      //完成
      $('#setPasswordNext').click(() => {
        var pwd = $('#pwd').val();
        var affirm_pwd = $('#affirm_pwd').val();
        console.log("pwd=" + pwd);
        console.log("affirm_pwd=" + affirm_pwd);
        if (pwd && $.trim(pwd) == $.trim(affirm_pwd)) {
          if (pwd.length < 8) {
            alert("密码长度必须大于8位");
            return
          }

          var reg = /^.*(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]+.*$/
          reg = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\w\s])[^\s]{8,}$/

          if (!reg.test(pwd)) {
            alert("密码必须包含大小写字母+数字+特殊字符至少8位");
            return
          }
          resetPwd(pwd, affirm_pwd);
        } else {
          alert("两次输入密码不一致！");
          return
        }
      })

      /** 发送验证码 */
      $('#send-code').click(() => {
        var phoneNum = $('#input-phone-num2').val();
        // checkPhoneNum(phoneNum)
        sendPhoneCode(phoneNum);
      })

      /** 手机号码验证  第二步*/
      function checkPhoneNum(phone) {
        var bxReqs = [];
        var bxReq = {};
        bxReq.serviceName = "srvsso_check_mobile";
        bxReq.data = [{ "mobile": phone }];
        // //指定应用
        // var assignApp = sessionStorage.getItem("assignApp");
        // if (assignApp) {
        // 	bxReq.data[0]["application"] = assignApp;
        // }
        // //指定端口
        // var port = sessionStorage.getItem("assignPort");
        // if (port) {
        // 	bxReq.data[0]["port"] = port;
        // }
        //指定租户
        var tenant = sessionStorage.getItem("assignTenant");
        if (tenant) {
          bxReq.data[0]["tenant"] = tenant;
        }
        bxReqs.push(bxReq);

        var path = top.pathConfig.gateway + "/" + top.pathConfig.sso_app + "/operate/srvsso_check_mobile";
        var callBack = function (data) {
          if (data.state == "SUCCESS") {
            active = 1
            if (data.response?.[0]?.response?.bx_auth_ticket) {
              sessionStorage.setItem("bx_auth_ticket", data.response[0].response?.bx_auth_ticket);
            }
            setStyle() // 更新步骤显示
          } else {
            alert("手机号校验不存在")
          }
          console.log('校验手机号', data)

        }
        crosAjax(path, "POST", bxReqs, callBack);
      }
      /** 发送短信验证码 */
      function sendPhoneCode(phone) {
        var bxReqs = [];
        var bxReq = {};
        bxReq.serviceName = "srvsso_send_node";
        bxReq.data = [{ "mobile": phone, "type": "cfp" }];
        // //指定应用
        // var assignApp = sessionStorage.getItem("assignApp");
        // if (assignApp) {
        // 	bxReq.data[0]["application"] = assignApp;
        // }
        // //指定端口
        // var port = sessionStorage.getItem("assignPort");
        // if (port) {
        // 	bxReq.data[0]["port"] = port;
        // }
        //指定租户
        var tenant = sessionStorage.getItem("assignTenant");
        if (tenant) {
          bxReq.data[0]["tenant"] = tenant;
        }
        bxReqs.push(bxReq);

        var path = top.pathConfig.gateway + "/" + top.pathConfig.sso_app + "/operate/srvsso_send_node";
        var callBack = function (data) {
          if (data.state == "SUCCESS") {

            alert("短信发送成功，请注意查收！")
            var time = 60
            var timer = setInterval(function () {
              if (time == 0) {
                // 清除定时器和复原按钮
                clearInterval(timer);
                // btn.disabled = false;
                document.getElementById('send-code').innerHTML = '发送验证码'

                document.getElementById('send-code').disabled = false
                time = 60;
              } else {
                document.getElementById('send-code').disabled = true
                // btn.innerHTML = '剩余' + time + '秒';
                time--;

                document.getElementById('send-code').innerHTML = '剩余' + time + '秒'
              }
            }, 1000)
          } else {
            alert("短信发送失败！")
          }
        }
        crosAjax(path, "POST", bxReqs, callBack);
      }

      /** 短信验证码验证 校验短信验证码  第二步 */
      function checkPhoneCode(phoneCode) {

        // 短信验证接口未完成， 默认验证通过

        var bxReqs = [];
        var bxReq = {};
        bxReq.serviceName = "srvsso_check_mobile";
        bxReq.data = [{
          "mobile": document.getElementById('input-phone-num2').value,
          "mobile_code": document.getElementById('input-phone-code').value
        }];
        // //指定应用
        // var assignApp = sessionStorage.getItem("assignApp");
        // if (assignApp) {
        // 	bxReq.data[0]["application"] = assignApp;
        // }
        // //指定端口
        // var port = sessionStorage.getItem("assignPort");
        // if (port) {
        // 	bxReq.data[0]["port"] = port;
        // }
        //指定租户
        var tenant = sessionStorage.getItem("assignTenant");
        if (tenant) {
          bxReq.data[0]["tenant"] = tenant;
        }
        bxReqs.push(bxReq);

        var path = top.pathConfig.gateway + "/" + top.pathConfig.sso_app + "/operate/srvsso_check_mobile";
        var callBack = function (data) {
          if (data.state == "SUCCESS") {
            active = 2
            setStyle()
          } else {
            securityCheckState = false
            alert("验证码错误！")
            document.getElementById('input-phone-code').value = ''
          }
        }
        crosAjax(path, "POST", bxReqs, callBack);

      }

      function resetPwd(pwd, affirm_pwd) {
        var bxReqs = [];
        var bxReq = {};
        bxReq.serviceName = "srvsso_reset_pwd";
        bxReq.data = [{ "pwd": pwd, "affirm_pwd": affirm_pwd }];
        // //指定应用
        // var assignApp = sessionStorage.getItem("assignApp");
        // if (assignApp) {
        // 	bxReq.data[0]["application"] = assignApp;
        // }
        // //指定端口
        // var port = sessionStorage.getItem("assignPort");
        // if (port) {
        // 	bxReq.data[0]["port"] = port;
        // }
        //指定租户
        var tenant = sessionStorage.getItem("assignTenant");
        if (tenant) {
          bxReq.data[0]["tenant"] = tenant;
        }
        bxReqs.push(bxReq);

        var path = top.pathConfig.gateway + "/" + top.pathConfig.sso_app + "/operate/srvsso_reset_pwd";
        var callBack = function (data) {
          if (data.state == "SUCCESS") {
            active = 3
            setStyle()
          } else {
            console.log("密码设置失败！", data)
          }

        }
        crosAjax(path, "POST", bxReqs, callBack);
      }
    })

  </script>
</body>

</html>